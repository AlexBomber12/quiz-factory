# Metrics

## 1. Purpose
- This document governs the canonical definitions, formulas, and boundaries for product and finance metrics used in reporting and decision making.
- Non-goals:
  - Tracking personal identities or user accounts.
  - Estimating revenue from client-side pixels or ad platform reports.
  - Using qualitative feedback as a decision metric unless defined elsewhere.

## 2. Scope and assumptions
- Currency is EUR only.
- Multi-tenant: tenant_id identifies a site (domain + language + country + audience).
- No user accounts; users are anonymous.
- Revenue is recognized only from backend payment facts, not from client pixels.
- Raw timestamps are stored in UTC.
- Daily marts use a single configurable reporting timezone, default UTC.

## 3. Core identifiers
- tenant_id: format `tenant-<slug>`; generated in tenant provisioning.
- distinct_id: format `uuid_v4`; canonical anonymous visitor id (visitor_id); generated client-side on first visit and stored in local storage.
- session_id: format `uuid_v4`; canonical attempt id (attempt_id); generated on test_start to identify a single test attempt.
- test_id: format `test-<slug>`; generated in content pipeline and stored in the test catalog.
- purchase_id: format `uuid_v4`; generated in backend checkout service when a payment intent is created.
- order_id: format `order-<slug>`; generated in order service when separate from purchase_id, otherwise equal to purchase_id.
- refund_id: format `stripe_refund_id` like `re_...`; generated by Stripe and recorded after webhook.
- dispute_id: format `stripe_dispute_id` like `dp_...`; generated by Stripe and recorded after webhook.

Required dimensions for every fact row:
- tenant_id
- test_id
- timestamp_utc (ISO 8601)
- utm_source
- utm_medium
- utm_campaign
- utm_content
- utm_term
- referrer
- country
- language
- device_type

## 4. Event contract (high level)
- Base required properties for all events:
  - tenant_id
  - session_id
  - distinct_id
  - timestamp_utc (ISO 8601)
  - utm_source
  - utm_medium
  - utm_campaign
  - utm_content
  - utm_term
  - referrer
  - country
  - language
  - device_type
- page_view: test_id when the page is tied to a test.
- test_start: test_id.
- test_complete: test_id.
- result_preview_view: test_id.
- paywall_view: test_id.
- checkout_start: test_id.
- purchase_success: test_id, purchase_id, amount_eur, product_type, payment_provider, is_upsell, currency.
- purchase_failed: test_id, purchase_id, failure_reason.
- report_view: test_id, purchase_id.
- report_pdf_download: test_id, purchase_id.
- upsell_view: test_id, purchase_id.
- upsell_accept: test_id, purchase_id, upsell_id.
- refund_issued: purchase_id, refund_id, amount_eur, payment_provider.
- dispute_opened: purchase_id, dispute_id, amount_eur, payment_provider.
- share_click: test_id, share_target.
- purchase_success MUST be emitted server-side after Stripe webhook confirmation.
- Each event MUST include tenant_id, session_id, distinct_id, test_id (when applicable), timestamp_utc, and all UTM fields (may be null).

## 5. Funnel metrics (definitions and formulas)
- Visits: count of visit sessions derived from page_view events on attempt pages.
- Unique visitors: count of distinct distinct_id in the period.
- Test starts: count of test_start events.
- Test completions: count of test_complete events.
- Completion rate = test_complete / test_start.
- Paywall rate = paywall_view / test_complete.
- Checkout start rate = checkout_start / paywall_view.
- Purchase conversion = purchase_success / visits.
- Report view rate = report_view / purchase_success.
- Boundaries:
  - A visit is a browsing session separated by 30 minutes of inactivity.
  - Exclude internal traffic when property is_internal = true.
  - All rates must be computable per tenant_id, per test_id, and per channel.

## 6. Financial metrics (definitions and formulas)
- gross_revenue_eur = sum(amount_gross_eur) from successful purchases.
- payment_fees_eur = sum(processor_fees_eur) from Stripe balance transaction facts.
- refunds_eur = sum(refund_amount_eur) from successful refunds.
- disputes_fees_eur = sum(dispute_fee_eur) where applicable.
- net_revenue_eur = gross_revenue_eur - payment_fees_eur - refunds_eur - disputes_fees_eur.
- Cost buckets:
  - ad_spend_eur (per channel per day).
  - content_cost_eur (UGC, editing, translation).
  - infra_cost_eur (hosting, domains, tools).
- Margins:
  - contribution_margin_eur = net_revenue_eur - ad_spend_eur - content_cost_eur - infra_cost_eur.
- Taxes:
  - profit_after_tax_model_eur is a model-driven estimate, not a legal truth.
  - The tax model is configurable and will be implemented later as a table.

## 7. Unit economics (definitions and formulas)
- AOV = gross_revenue_eur / purchase_success_count.
- profit_per_purchase_eur = contribution_margin_eur / purchase_success_count.
- profit_per_visit_eur = contribution_margin_eur / visits.
- CAC_eur (channel) = ad_spend_eur / first_time_purchasers_count.
- Payback days: defined for future subscriptions as the days to recover CAC from contribution margin, future metric.
- Cohort LTV windows:
  - LTV_7, LTV_30, LTV_90 based on contribution margin per user cohort (distinct_id).

## 8. Attribution rules
- Last non-direct click attribution using UTM fields.
- Attribution window = 7 days.
- If no UTM, classify as direct, organic, or referral based on referrer.
- Classification rules: direct if referrer is empty or same-domain, organic if referrer matches known search engines, referral otherwise.

## 9. Data quality rules and reconciliation
- Deduplication rules: event_id if available; otherwise a distinct tuple of event_name + timestamp_utc + session_id.
- Required fields must be non-null for backend facts (purchase, refund, dispute).
- Daily reconciliation checks:
  - purchases_count in Stripe facts matches purchase_success events within tolerance.
  - gross_revenue_eur matches Stripe totals within tolerance.
- Alert thresholds (examples):
  - purchase conversion drops by 30 percent day over day.
  - refund rate exceeds 5 percent.
  - missing Stripe webhook ingestion for 30 minutes.

## 10. Privacy and retention
- Do not store raw free-text answers unless explicitly required.
- Prefer storing only derived scores per scale.
- Stripe raw payloads may contain PII and must not be stored in analytics raw tables.
- Only minimal Stripe facts and our own metadata keys are allowed.
- Retention defaults (example):
  - raw events retained 18 months.
  - finance facts retained 7 years (accounting needs).
- Sensitive categories (politics, health) are high risk and require explicit design decisions.

## 11. Change control
- Changes require PR.
- Every change must include:
  - the new definition.
  - effective date.
  - backward compatibility notes.

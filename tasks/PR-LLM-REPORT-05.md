PR-LLM-REPORT-05: Render LLM Report (API Access, Client Polling, Print Support)

Read and follow AGENTS.md strictly.

Context
- report_artifacts can now be generated by the internal runner.
- Public report UI still renders static band copy.
- We need the paid report to display the generated report, with a safe fallback and a "generating" state.

Goal
- Update /api/report/access to return generated report content when available.
- If the report is not generated yet, show a generating state and poll until ready.
- Update report and print clients to render generated sections.

Non-goals
- No new PDF pipeline. The existing print-to-PDF flow should continue working.
- No user-controlled style switching yet.

Workflow rules
- Create a new branch from main named: pr-llm-report-05-rendering
- Implement only what this task requests.
- Do not commit secrets.
- Keep everything in English.
- Avoid using em dashes; use hyphens.
- Run the project test gate locally before committing.

Task A: Artifact repo
A1) Add repo helpers for report_artifacts.
- Create: apps/web/src/lib/report/report_artifact_repo.ts
- Functions:
  - getReportArtifactByPurchaseId(purchaseId)
  - upsertReportArtifact(artifact)
- Ensure reads are tenant-safe by validating tenant_id/test_id/session_id match before returning to callers.

Task B: /api/report/access returns generated content
B1) Extend /api/report/access to include generated content.
- File: apps/web/src/app/api/report/access/route.ts
- Behavior for both access modes (cookie access and report_link_token):
  - Determine purchase_id, tenant_id, test_id, session_id as before.
  - Try to load report_artifact by purchase_id.
  - If artifact exists and matches context:
    - Return the existing response payload, plus a new field:
      - generated: { report_json, style_id, model, prompt_version, scoring_version }

B2) If artifact does not exist, attempt on-demand generation.
- On-demand generation rules:
  - If OPENAI_API_KEY is missing: do not attempt generation. Return 409 with error "report not generated".
  - Ensure a report_job exists for purchase_id (enqueue if missing).
  - If job is already running: return 202 with { status: "generating" }.
  - If attempt_summaries exists for this session:
    - Build ReportBrief.
    - Infer styleId.
    - Generate report JSON.
    - Insert report_artifact and mark job ready.
    - Return the ready payload.
  - If attempt summary is missing:
    - Return 409 with error "result summary missing".

B3) Response codes
- 202: generating
- 409: cannot generate now (missing config or missing summary)
- Keep existing 401/402/403/404 behavior unchanged.

Task C: Client polling + UI rendering
C1) Update ReportClient to handle 202.
- File: apps/web/src/app/report/[slug]/report-client.tsx
- If /api/report/access returns 202:
  - show "Generating your report" state
  - poll with backoff (for example: 500ms, 1000ms, 2000ms, 3000ms, max 5000ms)
  - stop after 30 seconds and show an error

C2) Render generated report sections.
- Create: apps/web/src/app/report/[slug]/generated-report.tsx
- Render:
  - report_json.summary (headline + bullets)
  - report_json.sections (title, body, bullets)
  - report_json.action_plan
  - report_json.disclaimers
- Keep it simple: no markdown rendering.
- In ReportClient, prefer generated content when present; otherwise keep the legacy sections.

C3) Update PrintClient similarly.
- File: apps/web/src/app/report/[slug]/print/print-client.tsx
- Handle 202 generating.
- Render generated-report output instead of the legacy band block when generated exists.

Task D: Tests
D1) Add a unit test for generated-report rendering via server render.
- Create: apps/web/src/app/report/[slug]/generated-report.test.tsx
- Use a minimal report_json fixture.
- Use react-dom/server renderToStaticMarkup.
- Verify the rendered HTML contains:
  - summary headline text
  - at least 1 section title
  - at least 1 disclaimer

D2) Add a route-level test for report access behavior (no network calls).
- Update or add a vitest test that stubs report_artifact_repo to:
  - return null -> expect 202 or 409 depending on OPENAI_API_KEY presence (simulate via env override)
  - return an artifact -> expect ok payload includes generated

Success criteria
- scripts/ci.sh exits 0.
- After checkout, /report/<slug> shows generating and then renders the generated report (when OPENAI_API_KEY is set).
- /report/<slug>/print renders the same generated content.
